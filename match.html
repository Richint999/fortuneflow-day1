
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Partner Match</title><link rel="stylesheet" href="styles.css"></head><body>
<div class="topbar"><div class="container row"><div class="brand">FortuneFlow</div><nav>
  <a href="index.html">Home</a><a href="report.html">Report</a><a href="match.html" aria-current="page">Partner Match</a><a href="pricing.html">Pricing</a><a href="account.html">Account</a>
</nav></div></div>
<div class="container"><h1>Partner Match</h1>
<section class="card">
  <div class="grid cols-2">
    <div>
      <h3>You</h3>
      <div class="grid cols-2">
        <div><label>Country</label><select id="a-country">
          <option value="US">United States</option><option value="CN" selected>China</option><option value="CA">Canada</option><option value="UK">United Kingdom</option><option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option><option value="ES">Spain</option>
        </select></div>
        <div><label>Hour (optional)</label><select id="a-hour">
          <option value="">Unknown</option>
          <option value="1">01:00</option><option value="3">03:00</option><option value="5">05:00</option><option value="7">07:00</option>
          <option value="9">09:00</option><option value="11">11:00</option><option value="13">13:00</option><option value="15">15:00</option>
          <option value="17">17:00</option><option value="19">19:00</option><option value="21">21:00</option><option value="23">23:00</option>
        </select></div>
        <div><label>Year</label><input id="a-y" type="number" min="1900" max="2100" placeholder="1988"></div>
        <div><label>Month</label><input id="a-m" type="number" min="1" max="12" placeholder="7"></div>
        <div><label>Day</label><input id="a-d" type="number" min="1" max="31" placeholder="15"></div>
      </div>
    </div>
    <div>
      <h3>Partner</h3>
      <div class="grid cols-2">
        <div><label>Country</label><select id="b-country">
          <option value="US">United States</option><option value="CN" selected>China</option><option value="CA">Canada</option><option value="UK">United Kingdom</option><option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option><option value="ES">Spain</option>
        </select></div>
        <div><label>Hour (optional)</label><select id="b-hour">
          <option value="">Unknown</option>
          <option value="1">01:00</option><option value="3">03:00</option><option value="5">05:00</option><option value="7">07:00</option>
          <option value="9">09:00</option><option value="11">11:00</option><option value="13">13:00</option><option value="15">15:00</option>
          <option value="17">17:00</option><option value="19">19:00</option><option value="21">21:00</option><option value="23">23:00</option>
        </select></div>
        <div><label>Year</label><input id="b-y" type="number" min="1900" max="2100" placeholder="1990"></div>
        <div><label>Month</label><input id="b-m" type="number" min="1" max="12" placeholder="8"></div>
        <div><label>Day</label><input id="b-d" type="number" min="1" max="31" placeholder="20"></div>
      </div>
    </div>
  </div>
  <div style="margin-top:12px"><button id="calc">Calculate Score</button></div>
  <div id="score" style="margin-top:14px;font-size:22px;font-weight:800"></div>
  <div id="explain" class="small" style="margin-top:8px"></div>
</section>
<section class="card small">
  <b>Note</b>: If hour is unknown, we score using Year/Month/Day only.
</section>
</div>
<script src="utils.js"></script>
<script>
  function buildPillars(y,m,d,hrOpt){
    // Use civil date as-is (TST/local-hour logic could be added later); if hour unknown, skip hour pillar.
    // 1) Day pillar
    const dP = sexagenaryDay(y,m,d);
    // 2) Year pillar (adjusted by Li Chun)
    const dt = new Date(Date.UTC(y, m-1, d));
    const yAdj = lichunAdjustedYear(dt);
    const yP = sexagenaryYear(yAdj);
    // 3) Month pillar (approx by solar terms table)
    const mP = monthPillar(yP[0], dt);
    // 4) Hour pillar if provided
    let hP = null;
    if (hrOpt !== null && hrOpt !== undefined && hrOpt !== ''){
      const hr = parseInt(hrOpt,10);
      const hh = hourPillar(dP[0], hr);
      hP = hh;
    }
    return { y:yP, m:mP, d:dP, h:hP };
  }

  function countsFromPillars(P){
    const packs=[{s:P.y[0],b:P.y[1]},{s:P.m[0],b:P.m[1]},{s:P.d[0],b:P.d[1]}];
    if (P.h) packs.push({s:P.h[0],b:P.h[1]});
    const arr = packs.map(x => tally(x.s, x.b));
    return total(arr);
  }

  const SIX_HARM=new Set(['子午','丑未','寅申','卯酉','辰戌','巳亥']);
  const SIX_COMB=new Set(['子丑','寅亥','卯戌','辰酉','巳申','午未']);
  const TR=[new Set(['申','子','辰']),new Set(['寅','午','戌']),new Set(['亥','卯','未']),new Set(['巳','酉','丑'])];
  const eStem=i=>STEMS[i].e, brZh=i=>BR[i].zh;
  function cycleRel(a,b){const o=['Wood','Fire','Earth','Metal','Water'];const ai=o.indexOf(a),bi=o.indexOf(b);if((ai+1)%5===bi)return 1;if((ai+4)%5===bi)return -1;return 0;}

  function score(A,B,det){
    const da = dom(A), db = dom(B);
    let comp = 0;
    if (da.least === db.most) comp += 22;
    if (db.least === da.most) comp += 10;
    if ((B[da.least]||0) - (A[da.least]||0) >= 2) comp += 8;
    const union={}; ['Wood','Fire','Earth','Metal','Water'].forEach(k=>union[k]=(A[k]||0)+(B[k]||0));
    const vals=['Wood','Fire','Earth','Metal','Water'].map(k=>union[k]); const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
    const v=vals.reduce((s,x)=>s+Math.pow(x-avg,2),0)/vals.length; const balance=Math.max(0,25*(1/(1+v)));
    let pair=brZh(det.a.db)+brZh(det.b.db),rev=pair.split('').reverse().join(''); let rel=0;
    if (SIX_COMB.has(pair)||SIX_COMB.has(rev)) rel+=12;
    if (SIX_HARM.has(pair)||SIX_HARM.has(rev)) rel+=6;
    TR.forEach(s=>{ if(s.has(brZh(det.a.db)) && s.has(brZh(det.b.db))) rel+=5; });
    const stemRel = cycleRel(eStem(det.a.ds), eStem(det.b.ds));
    const stemScore = stemRel===1?8:stemRel===-1?-6:2;
    const totalScore = Math.round(Math.max(0, Math.min(100, comp+balance+rel+stemScore)));
    return { total: totalScore, detail:{comp, balance:Math.round(balance), rel, stemScore}, domA:da, domB:db };
  }

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('calc').addEventListener('click',()=>{
      const ay=parseInt(document.getElementById('a-y').value,10);
      const am=parseInt(document.getElementById('a-m').value,10);
      const ad=parseInt(document.getElementById('a-d').value,10);
      const ah=document.getElementById('a-hour').value;
      const by=parseInt(document.getElementById('b-y').value,10);
      const bm=parseInt(document.getElementById('b-m').value,10);
      const bd=parseInt(document.getElementById('b-d').value,10);
      const bh=document.getElementById('b-hour').value;
      if(!(ay&&am&&ad&&by&&bm&&bd)){ alert('Please fill Year/Month/Day for both.'); return; }
      const A=buildPillars(ay,am,ad,ah), B=buildPillars(by,bm,bd,bh);
      const Ac=countsFromPillars(A), Bc=countsFromPillars(B);
      const det={ a:{ ds:A.d[0], db:A.d[1] }, b:{ ds:B.d[0], db:B.d[1] } };
      const r=score(Ac,Bc,det);
      const label=r.total>=85?'Excellent':r.total>=70?'Good':r.total>=50?'Neutral':'Challenging';
      document.getElementById('score').textContent='Score: '+r.total+' / 100 — '+label;
      const bullets=[]; bullets.push('You lack: '+r.domA.least+' | Partner strong in: '+r.domB.most);
      bullets.push('Shared balance bonus: '+r.detail.balance);
      if(r.detail.rel>=12) bullets.push('Heavenly combination sign — long-term harmony potential');
      else if(r.detail.rel>=6) bullets.push('Six-harmony sign — good chemistry');
      bullets.push('Day stem relation bonus: '+r.detail.stemScore);
      document.getElementById('explain').innerHTML=bullets.map(x=>'• '+x).join('<br>');
    });
  });
</script>
</body></html>
