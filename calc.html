<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FortuneFlow — Calc</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="topbar">
  <div class="container right">
    <label>🌐</label>
    <select id="lang">
      <option value="zh">中文</option>
      <option value="en">English</option>
      <option value="es">Español</option>
    </select>
  </div>
</div>

<div class="container">
  <h1 id="title">FortuneFlow — BaZi & Five Elements</h1>

  <!-- Unified Auto Four Pillars (with TST) -->
  <section id="ff-unified">
    <h2 id="i_auto_four">Auto Four Pillars</h2>
    <p id="i_tip">Select country, date, time. We'll fill the four pillars for you. Then results will be calculated automatically.</p>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <label for="ff-country" id="i_country_label">Country</label>
      <select id="ff-country"></select>

      <label for="ff-date" id="i_date_label">Birth Date</label>
      <input id="ff-date" type="date">

      <label for="ff-time" id="i_time_label">Birth Time</label>
      <input id="ff-time" type="time" value="12:00">

      <label style="margin-left:8px"><input type="checkbox" id="ff-tst"> <span id="i_tst">True Solar Time</span></label>
      <label style="margin-left:8px" id="i_lon_label">Longitude°</label>
      <input id="ff-lon" type="number" step="0.1" placeholder="e.g. 116.4" style="width:120px">

      <input id="ff-offset" type="hidden" value="0">
      <button id="ff-autofill"><span id="i_autofill">Auto-Fill</span></button>
    </div>
    <div id="ff-error" class="err"></div>
    <div id="ff-tst-time" style="margin-top:8px;color:#ffd34e"></div>
    <div id="ff-disp" style="margin-top:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
  </section>

  <!-- Day-1 Interactive Demo Panel -->
  <section>
    <h2>BaZi → Five Elements (Day-1 Demo)</h2>
    <p>Select your four pillars (Gan-Zhi). Day-2 will auto-convert from Gregorian date/time.</p>
    <div class="grid4">
      <div><label>Year Stem</label><select id="year-stem"></select>
           <label>Year Branch</label><select id="year-branch"></select></div>
      <div><label>Month Stem</label><select id="month-stem"></select>
           <label>Month Branch</label><select id="month-branch"></select></div>
      <div><label>Day Stem</label><select id="day-stem"></select>
           <label>Day Branch</label><select id="day-branch"></select></div>
      <div><label>Hour Stem</label><select id="hour-stem"></select>
           <label>Hour Branch</label><select id="hour-branch"></select></div>
    </div>
    <button id="calc-btn">Calculate</button>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
      <pre id="result-json" style="background:#0b1020;color:#e6e6e6;padding:12px;border-radius:10px;overflow:auto;min-height:120px"></pre>
      <div>
        <div id="advice" style="padding:12px;border:1px dashed #ddd;border-radius:10px;min-height:120px"></div>
        <div id="five-bars"></div>
      </div>
    </div>
  </section>
</div>

<!-- Inline scripts: i18n + geo + bazi + fortune + init -->
<script>
// === i18n ===
const I18N = {
  en: {
    title:"FortuneFlow — BaZi & Five Elements",
    auto_four:"Auto Four Pillars",
    tip:"Select country, date, time. We'll fill the four pillars for you. Then results will be calculated automatically.",
    country:"Country", birth_date:"Birth Date", birth_time:"Birth Time",
    tst:"True Solar Time", lon:"Longitude°", autofill:"Auto-Fill",
    err_date:"Please select your birth date.", tst_show:"True Solar Time"
  },
  zh: {
    title:"FortuneFlow — 八字与五行",
    auto_four:"自动排四柱",
    tip:"选择国家、出生日期和时间，我们会自动计算四柱，并输出结果。",
    country:"国家", birth_date:"出生日期", birth_time:"出生时间",
    tst:"真太阳时", lon:"经度°", autofill:"一键生成",
    err_date:"请先选择出生日期。", tst_show:"真太阳时"
  },
  es: {
    title:"FortuneFlow — BaZi y Cinco Elementos",
    auto_four:"Cuatro Pilares Automáticos",
    tip:"Selecciona país, fecha y hora. Completaremos los cuatro pilares y calcularemos los resultados automáticamente.",
    country:"País", birth_date:"Fecha de nacimiento", birth_time:"Hora de nacimiento",
    tst:"Hora Solar Verdadera", lon:"Longitud°", autofill:"Auto-Rellenar",
    err_date:"Por favor, selecciona tu fecha de nacimiento.", tst_show:"Hora Solar Verdadera"
  }
};
function detectLang(){ try{ const s=localStorage.getItem('ff_lang'); if(s) return s; const n=(navigator.languages&&navigator.languages[0])||navigator.language||'en'; if(n.toLowerCase().startsWith('zh')) return 'zh'; if(n.toLowerCase().startsWith('es')) return 'es'; return 'en'; }catch(e){return 'en';} }
function setLang(l){ localStorage.setItem('ff_lang', l); applyLang(l); }
function applyLang(l){
  const t=I18N[l]||I18N.en;
  document.title=t.title;
  document.getElementById('title').textContent=t.title;
  document.getElementById('i_auto_four').textContent=t.auto_four;
  document.getElementById('i_tip').textContent=t.tip;
  document.getElementById('i_country_label').textContent=t.country;
  document.getElementById('i_date_label').textContent=t.birth_date;
  document.getElementById('i_time_label').textContent=t.birth_time;
  document.getElementById('i_tst').textContent=t.tst;
  document.getElementById('i_lon_label').textContent=t.lon;
  document.getElementById('i_autofill').textContent=t.autofill;
  document.getElementById('ff-error').textContent=t.err_date;
}
</script>

<script>
// === Country -> UTC (DST approx) ===
const COUNTRY_TIME = [
  ["China (+08:00)", 480, 480, false, "N"],
  ["USA - Los Angeles (-480/-420)", -480, -420, true, "N"],
  ["USA - New York (-300/-240)", -300, -240, true, "N"],
  ["Canada - Toronto (-300/-240)", -300, -240, true, "N"],
  ["Hong Kong (+08:00)", 480, 480, false, "N"],
  ["Taiwan (+08:00)", 480, 480, false, "N"],
  ["Japan (+09:00)", 540, 540, false, "N"],
  ["South Korea (+09:00)", 540, 540, false, "N"],
  ["Mexico City (-360)", -360, -360, false, "N"],
  ["Spain (+60/+120)", 60, 120, true, "N"],
  ["United Kingdom (0/+60)", 0, 60, true, "N"],
  ["Germany (+60/+120)", 60, 120, true, "N"],
  ["France (+60/+120)", 60, 120, true, "N"],
  ["Italy (+60/+120)", 60, 120, true, "N"],
  ["Netherlands (+60/+120)", 60, 120, true, "N"],
  ["Greece (+120/+180)", 120, 180, true, "N"],
  ["UAE (+240)", 240, 240, false, "N"],
  ["Australia - Sydney (+10/+11)", 600, 660, true, "S"],
  ["New Zealand - Wellington (+12/+13)", 720, 780, true, "S"]
];
function populateCountrySelect(id){ const sel=document.getElementById(id); sel.innerHTML=""; COUNTRY_TIME.forEach((r,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=r[0]; sel.appendChild(o); }); }
function inferOffset(countryIdx, dateStr){ const r=COUNTRY_TIME[countryIdx]; if(!r) return 0; const [name,std,dst,hasDST,hemi]=r; if(!hasDST||!dateStr) return std; const [y,m,d]=dateStr.split('-').map(x=>parseInt(x,10)); const mmdd=m*100+d; if(hemi==="N"){ return (mmdd>=401 && mmdd<=1031)?dst:std; } else { return ((mmdd>=1101 && mmdd<=1231) || (mmdd>=101 && mmdd<=331))?dst:std; } }
</script>

<script>
// === BaZi core (with TST) ===
const STEMS = ["Jia","Yi","Bing","Ding","Wu","Ji","Geng","Xin","Ren","Gui"];
const STEMS_ZH = ["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"];
const BRANCHES = ["Zi","Chou","Yin","Mao","Chen","Si","Wu","Wei","Shen","You","Xu","Hai"];
const BRANCHES_ZH = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
const BRANCH_TO_ELEMENT = {Zi:"Water", Chou:"Earth", Yin:"Wood", Mao:"Wood", Chen:"Earth", Si:"Fire", Wu:"Fire", Wei:"Earth", Shen:"Metal", You:"Metal", Xu:"Earth", Hai:"Water"};
const STEM_TO_ELEMENT = {Jia:"Wood", Yi:"Wood", Bing:"Fire", Ding:"Fire", Wu:"Earth", Ji:"Earth", Geng:"Metal", Xin:"Metal", Ren:"Water", Gui:"Water"};
function mod(n,m){ return ((n % m) + m) % m; }
function lichunAdjustedYear(date){ const y=date.getUTCFullYear(), m=date.getUTCMonth(), d=date.getUTCDate(); if(m<1) return y-1; if(m===1 && d<4) return y-1; return y; }
function sexagenaryYear(yAdj){ return [mod((yAdj-4),10), mod((yAdj-4),12)]; }
function monthPillar(yearStemIdx, date){
  const m=date.getUTCMonth(), d=date.getUTCDate();
  const start={1:4,2:6,3:5,4:6,5:6,6:7,7:8,8:8,9:8,10:7,11:7,12:6};
  let idxFromTiger=0;
  if(m===1) idxFromTiger = (d>=start[1])?1:12;
  else if(m===2) idxFromTiger=(d>=start[2])?2:1;
  else if(m===3) idxFromTiger=(d>=start[3])?3:2;
  else if(m===4) idxFromTiger=(d>=start[4])?4:3;
  else if(m===5) idxFromTiger=(d>=start[5])?5:4;
  else if(m===6) idxFromTiger=(d>=start[6])?6:5;
  else if(m===7) idxFromTiger=(d>=start[7])?7:6;
  else if(m===8) idxFromTiger=(d>=start[8])?8:7;
  else if(m===9) idxFromTiger=(d>=start[9])?9:8;
  else if(m===10) idxFromTiger=(d>=start[10])?10:9;
  else if(m===11) idxFromTiger=(d>=start[11])?11:10;
  else if(m===0) idxFromTiger=(d>=start[12])?12:11;
  const branchIdx = mod(2 + (idxFromTiger-1), 12);
  const tigerStart = {0:2,5:2, 1:4,6:4, 2:6,7:6, 3:8,8:8, 4:0,9:0}[yearStemIdx];
  const stemIdx = mod(tigerStart + (idxFromTiger-1), 10);
  return [stemIdx, branchIdx];
}
function julianDayNumber(y,m,d){ const a=Math.floor((14-m)/12); const y2=y+4800-a; const m2=m+12*a-3; return d + Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045; }
function sexagenaryDay(y,m,d){ const jdn=julianDayNumber(y,m,d); const idx60=mod(jdn+49,60); return [idx60%10, idx60%12]; }
function hourBranchIndex(hour){ return Math.floor(((hour + 1) % 24) / 2); }
function hourStemIndex(dayStemIdx, hourBranchIdx){ const start={0:0,5:0,1:2,6:2,2:4,7:4,3:6,8:6,4:8,9:8}[dayStemIdx]; return mod(start + hourBranchIdx, 10); }
function parseOffsetMinutes(raw){ if (raw==null) return 0; const s=String(raw).trim(); if(s==="") return 0; const m=s.match(/^([+-]?)(\d{1,2})(?::?(\d{2}))?$/); if(m){ const sign=m[1]==="-"?-1:1; const hh=parseInt(m[2]||"0",10); const mm=parseInt(m[3]||"0",10); if (hh<=24) return sign*(hh*60+mm);} const n=Number(s); if(!isNaN(n)){ if(Math.abs(n)<=24) return Math.round(n*60); return Math.round(n); } throw new Error("Invalid UTC offset format"); }
function dayOfYearUTC(date){ const start=Date.UTC(date.getUTCFullYear(),0,1); return Math.floor((date.getTime()-start)/(1000*60*60*24))+1; }
function equationOfTimeMinutes(doy){ const B=2*Math.PI*(doy-81)/364.0; return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B); }
function standardMeridianDeg(offsetMinutes){ return (offsetMinutes/60)*15; }
function adjustHourByTST(localHour, localMinute, longitudeDeg, offsetMinutes, utcDate){ const std=standardMeridianDeg(offsetMinutes); const delta=4*(longitudeDeg-std)+equationOfTimeMinutes(dayOfYearUTC(utcDate)); const total=localHour*60+localMinute+delta; let m=((total%1440)+1440)%1440; return {hour:Math.floor(m/60), minute:Math.round(m%60)}; }
function autoFourPillarsFromInput(dateStr, timeStr, utcOffsetMinutesRaw){ 
  if(!dateStr) throw new Error("Missing date");
  const [y,m,d]=dateStr.split("-").map(x=>parseInt(x,10));
  let hr=12, min=0; if(timeStr){ const parts=timeStr.split(":"); hr=parseInt(parts[0]||"12",10); min=parseInt(parts[1]||"0",10); }
  const utcOffsetMinutes = parseOffsetMinutes(utcOffsetMinutesRaw);
  const localWall = new Date(Date.UTC(y,(m-1),d,hr,min));
  const utcMillis = localWall.getTime() - utcOffsetMinutes*60*1000;
  const utcDate = new Date(utcMillis);

  const yAdj = lichunAdjustedYear(utcDate);
  const [yStem, yBranch] = sexagenaryYear(yAdj);
  const [mStem, mBranch] = monthPillar(yStem, utcDate);
  const [dStem, dBranch] = sexagenaryDay(utcDate.getUTCFullYear(), utcDate.getUTCMonth()+1, utcDate.getUTCDate());

  const tstOn = document.getElementById("ff-tst")?.checked;
  const lonVal = parseFloat((document.getElementById("ff-lon")?.value||"").trim());
  let hourForBranch = hr;
  if (tstOn && !isNaN(lonVal)){ const adj = adjustHourByTST(hr, min, lonVal, utcOffsetMinutes, utcDate); hourForBranch = adj.hour;
    const label = document.getElementById("ff-tst-time"); if(label){ const t = (I18N[document.getElementById('lang').value]||I18N.en).tst_show; label.textContent = t + ": " + String(adj.hour).padStart(2,"0")+":"+String(adj.minute).padStart(2,"0"); } }
  else { const label = document.getElementById("ff-tst-time"); if(label) label.textContent=""; }

  const hBranch = hourBranchIndex(hourForBranch);
  const hStem = hourStemIndex(dStem, hBranch);
  return { year:{stemIdx:yStem, branchIdx:yBranch},
           month:{stemIdx:mStem, branchIdx:mBranch},
           day:{stemIdx:dStem, branchIdx:dBranch},
           hour:{stemIdx:hStem, branchIdx:hBranch},
           meta:{stems:STEMS, stemsZh:STEMS_ZH, branches:BRANCHES, branchesZh:BRANCHES_ZH, yAdj} };
}
</script>

<script>
// === Five Elements calc & UI ===
const ELEMENTS = ["Wood","Fire","Earth","Metal","Water"];
const STEMS_DATA = [
  {key:"Jia", zh:"甲", element:"Wood"},
  {key:"Yi", zh:"乙", element:"Wood"},
  {key:"Bing", zh:"丙", element:"Fire"},
  {key:"Ding", zh:"丁", element:"Fire"},
  {key:"Wu", zh:"戊", element:"Earth"},
  {key:"Ji", zh:"己", element:"Earth"},
  {key:"Geng", zh:"庚", element:"Metal"},
  {key:"Xin", zh:"辛", element:"Metal"},
  {key:"Ren", zh:"壬", element:"Water"},
  {key:"Gui", zh:"癸", element:"Water"}
];
const BRANCHES_DATA = [
  {key:"Zi", zh:"子", hidden:["Water"]},
  {key:"Chou", zh:"丑", hidden:["Earth","Water","Metal"]},
  {key:"Yin", zh:"寅", hidden:["Wood","Fire","Earth"]},
  {key:"Mao", zh:"卯", hidden:["Wood"]},
  {key:"Chen", zh:"辰", hidden:["Earth","Wood","Water"]},
  {key:"Si", zh:"巳", hidden:["Fire","Metal","Earth"]},
  {key:"Wu", zh:"午", hidden:["Fire","Earth"]},
  {key:"Wei", zh:"未", hidden:["Earth","Wood","Fire"]},
  {key:"Shen", zh:"申", hidden:["Metal","Water","Earth"]},
  {key:"You", zh:"酉", hidden:["Metal"]},
  {key:"Xu", zh:"戌", hidden:["Earth","Fire","Metal"]},
  {key:"Hai", zh:"亥", hidden:["Water","Wood"]}
];
function buildSelect(options, id){ const sel=document.getElementById(id); sel.innerHTML=""; options.forEach((o,idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=`${o.zh} (${o.key})`; sel.appendChild(opt); }); }
function tallyElements(stemIdx, branchIdx){ const c={Wood:0,Fire:0,Earth:0,Metal:0,Water:0}; c[STEMS_DATA[stemIdx].element]+=1; BRANCHES_DATA[branchIdx].hidden.forEach(e=>c[e]+=1); return c; }
function combineCounts(arr){ const t={Wood:0,Fire:0,Earth:0,Metal:0,Water:0}; arr.forEach(c=>ELEMENTS.forEach(e=>t[e]+=c[e])); return t; }
function bestColors(element){ const map={Wood:["green","cyan"], Fire:["red","orange"], Earth:["yellow","brown"], Metal:["white","silver","gold"], Water:["black","blue","navy"]}; return map[element]||[]; }
function adviceFromCounts(counts){ const entries=ELEMENTS.map(e=>[e,counts[e]]).sort((a,b)=>b[1]-a[1]); const most=entries[0][0], least=entries[4][0]; return { most, least, luckyColors: bestColors(least) };}
function renderBars(counts){ const container=document.getElementById('five-bars'); container.innerHTML=''; ELEMENTS.forEach(e=>{ const bar=document.createElement('div'); bar.className='bar'; const v=counts[e]; bar.style.height=(10+v*22)+'px'; bar.title=`${e}: ${v}`; const label=document.createElement('span'); label.textContent=`${e} ${v}`; bar.appendChild(label); container.appendChild(bar); }); }
function onCalculate(){ const pillars=['year','month','day','hour'].map(p=>{ const s=parseInt(document.getElementById(p+'-stem').value,10); const b=parseInt(document.getElementById(p+'-branch').value,10); return tallyElements(s,b); }); const total=combineCounts(pillars); renderBars(total); const adv=adviceFromCounts(total); document.getElementById('result-json').textContent=JSON.stringify(total,null,2); document.getElementById('advice').innerHTML=`<b>Most abundant:</b> ${adv.most}<br/><b>Weakest:</b> ${adv.least}<br/><b>Lucky colors:</b> ${adv.luckyColors.join(", ")||"—"}`; }
document.addEventListener('DOMContentLoaded', function(){ ['year','month','day','hour'].forEach(p=>{ buildSelect(STEMS_DATA, p+'-stem'); buildSelect(BRANCHES_DATA, p+'-branch'); }); document.getElementById('calc-btn').addEventListener('click', onCalculate); });
</script>

<script>
// === Init: i18n + country + autofill ===
document.addEventListener('DOMContentLoaded', function(){
  const initLang = (localStorage.getItem('ff_lang') || (navigator.language||'en').toLowerCase().startsWith('zh') ? 'zh' : ((navigator.language||'en').toLowerCase().startsWith('es') ? 'es' : 'en'));
  const langSel=document.getElementById('lang'); langSel.value = initLang; langSel.addEventListener('change', ()=>setLang(langSel.value)); applyLang(initLang);
  populateCountrySelect('ff-country');
  function syncOffset(){ const countryIdx=parseInt(document.getElementById('ff-country').value||'0',10); const dateStr=(document.getElementById('ff-date').value||''); const off=inferOffset(countryIdx, dateStr); document.getElementById('ff-offset').value=String(off); }
  document.getElementById('ff-country').addEventListener('change', syncOffset);
  document.getElementById('ff-date').addEventListener('change', syncOffset); syncOffset();
  document.getElementById('ff-autofill').addEventListener('click', function(){
    const err=document.getElementById('ff-error'); err.style.display='none';
    const dateStr=(document.getElementById('ff-date').value||'').trim();
    const timeStr=(document.getElementById('ff-time').value||'').trim();
    const offStr =(document.getElementById('ff-offset').value||'0').trim();
    if(!dateStr){ err.style.display='block'; return; }
    try{
      const pillars = autoFourPillarsFromInput(dateStr, timeStr, offStr);
      const map={year:'year', month:'month', day:'day', hour:'hour'};
      Object.keys(map).forEach(k=>{ const s=document.getElementById(map[k]+'-stem'); const b=document.getElementById(map[k]+'-branch'); if(s&&b){ s.value=String(pillars[k].stemIdx); b.value=String(pillars[k].branchIdx); }});
      const S=STEMS_ZH, B=BRANCHES_ZH; const fmt=p=>S[p.stemIdx]+B[p.branchIdx];
      document.getElementById('ff-disp').innerHTML = `<div style="padding:10px;border:1px solid #eee;border-radius:8px">
        <div><b>Year:</b> ${fmt(pillars.year)}</div>
        <div><b>Month:</b> ${fmt(pillars.month)}</div>
        <div><b>Day:</b> ${fmt(pillars.day)}</div>
        <div><b>Hour:</b> ${fmt(pillars.hour)}</div>
      </div>`;
      document.getElementById('calc-btn').click();
      document.getElementById('five-bars').scrollIntoView({behavior:'smooth', block:'center'});
    }catch(e){ err.textContent=e.message||'Error'; err.style.display='block'; console.error(e); }
  });
});
</script>

</body>
</html>
