<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>FortuneFlow ‚Äî Calc</title><link rel='stylesheet' href='styles.css'></head><body><div class="topbar no-print">
  <div class="container row">
    <div class="brand">FortuneFlow</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="pricing.html">Pricing</a>
      <a href="account.html">Account</a>
      <a href="report.html">Report</a>
      <label>üåê</label>
      <select id="lang" style="padding:6px 10px;border-radius:8px;border:1px solid #2a3d63">
        <option value="zh">‰∏≠Êñá</option>
        <option value="en" selected>English</option>
        <option value="es">Espa√±ol</option>
      </select>
    </nav>
  </div>
</div><div class="container"><h1 id="title-text">FortuneFlow ‚Äî Calc</h1>
  <section class="card">
    <h2 id="i_auto_four">Auto Four Pillars</h2>
    <p id="i_tip">Select country, date, time. We'll fill the four pillars for you. Then results will be calculated automatically.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <label id="i_country_label" for="ff-country">Country</label><select id="ff-country"></select>
      <label id="i_date_label" for="ff-date">Birth Date</label><input id="ff-date" type="date">
      <label id="i_time_label" for="ff-time">Birth Time</label><input id="ff-time" type="time" value="12:00">
      <label style="margin-left:8px"><input type="checkbox" id="ff-tst"> <span id="i_tst">True Solar Time</span></label>
      <label style="margin-left:8px" id="i_lon_label">Longitude¬∞</label><input id="ff-lon" type="number" step="0.1" placeholder="116.4" style="width:120px">
      <input id="ff-offset" type="hidden" value="0">
      <button id="ff-autofill"><span id="i_autofill">Auto-Fill</span></button>
    </div>
    <div id="ff-error" class="err"></div>
    <div id="ff-tst-time" style="margin-top:8px;color:#ffd34e"></div>
    <div id="ff-disp" class="mono" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h2 id='i_demo_title'>BaZi ‚Üí Five Elements (Demo)</h2>
    <div class="grid cols-2">
      <div>
        <div class="grid cols-2">
          <div><label>Year Stem</label><select id="year-stem"></select></div>
          <div><label>Year Branch</label><select id="year-branch"></select></div>
          <div><label>Month Stem</label><select id="month-stem"></select></div>
          <div><label>Month Branch</label><select id="month-branch"></select></div>
          <div><label>Day Stem</label><select id="day-stem"></select></div>
          <div><label>Day Branch</label><select id="day-branch"></select></div>
          <div><label>Hour Stem</label><select id="hour-stem"></select></div>
          <div><label>Hour Branch</label><select id="hour-branch"></select></div>
        </div>
        <div style="margin-top:10px">
          <button id="calc-btn">Calculate</button>
          <a class="button" href="report.html" id="open-report">Open Report</a>
        </div>
      </div>
      <div>
        <div id="result-json" class="mono" style="min-height:140px;background:#0b1020;border:1px solid #203052;border-radius:10px;padding:10px"></div>
        <div id="advice" style="margin-top:10px"></div>
        <div id="five-bars"></div>
      </div>
    </div>
  </section></div><script>
const I18N={en:{title:"FortuneFlow ‚Äî BaZi & Five Elements",auto_four:"Auto Four Pillars",tip:"Select country, date, time. We'll fill the four pillars for you. Then results will be calculated automatically.",country:"Country",birth_date:"Birth Date",birth_time:"Birth Time",tst:"True Solar Time",lon:"Longitude¬∞",autofill:"Auto-Fill",err_date:"Please select your birth date.",tst_show:"True Solar Time",pricing:"Pricing",basic:"Basic",pro:"Pro",vip:"VIP",buy:"Buy Now",month:"/month",features:"Features",includes:"Includes",checkout:"Checkout",name:"Full Name",email:"Email",submit:"Submit",thanks:"Thank you! We'll contact you shortly.",report:"Report",download:"Download / Print",backhome:"Back to Home",pillars:"Pillars",elements:"Five Elements",lucky:"Lucky Colors",strongest:"Strongest",weakest:"Weakest"},
zh:{title:"FortuneFlow ‚Äî ÂÖ´Â≠ó‰∏é‰∫îË°å",auto_four:"Ëá™Âä®ÊéíÂõõÊü±",tip:"ÈÄâÊã©ÂõΩÂÆ∂„ÄÅÂá∫ÁîüÊó•ÊúüÂíåÊó∂Èó¥ÔºåÊàë‰ª¨‰ºöËá™Âä®ËÆ°ÁÆóÂõõÊü±ÔºåÂπ∂ËæìÂá∫ÁªìÊûú„ÄÇ",country:"ÂõΩÂÆ∂",birth_date:"Âá∫ÁîüÊó•Êúü",birth_time:"Âá∫ÁîüÊó∂Èó¥",tst:"ÁúüÂ§™Èò≥Êó∂",lon:"ÁªèÂ∫¶¬∞",autofill:"‰∏ÄÈîÆÁîüÊàê",err_date:"ËØ∑ÂÖàÈÄâÊã©Âá∫ÁîüÊó•Êúü„ÄÇ",tst_show:"ÁúüÂ§™Èò≥Êó∂",pricing:"‰ª∑Ê†º",basic:"Âü∫Á°ÄÁâà",pro:"‰∏ì‰∏öÁâà",vip:"ÊóóËà∞Áâà",buy:"Á´ãÂç≥Ë¥≠‰π∞",month:"/Êúà",features:"ÂäüËÉΩ",includes:"ÂåÖÂê´",checkout:"ÁªìË¥¶",name:"ÂßìÂêç",email:"ÈÇÆÁÆ±",submit:"Êèê‰∫§",thanks:"ÊÑüË∞¢ÔºÅÊàë‰ª¨‰ºöÂ∞ΩÂø´ËÅîÁ≥ª‰Ω†„ÄÇ",report:"Êä•Âëä",download:"‰∏ãËΩΩ/ÊâìÂç∞",backhome:"ËøîÂõûÈ¶ñÈ°µ",pillars:"ÂõõÊü±",elements:"‰∫îË°å",lucky:"Âπ∏ËøêËâ≤",strongest:"ÊúÄÊó∫",weakest:"ÊúÄÂº±"},
es:{title:"FortuneFlow ‚Äî BaZi y Cinco Elementos",auto_four:"Cuatro Pilares Autom√°ticos",tip:"Selecciona pa√≠s, fecha y hora. Completaremos los cuatro pilares y calcularemos los resultados autom√°ticamente.",country:"Pa√≠s",birth_date:"Fecha de nacimiento",birth_time:"Hora de nacimiento",tst:"Hora Solar Verdadera",lon:"Longitud¬∞",autofill:"Auto-Rellenar",err_date:"Por favor, selecciona tu fecha de nacimiento.",tst_show:"Hora Solar Verdadera",pricing:"Precios",basic:"B√°sico",pro:"Pro",vip:"VIP",buy:"Comprar",month:"/mes",features:"Funciones",includes:"Incluye",checkout:"Pagar",name:"Nombre Completo",email:"Correo",submit:"Enviar",thanks:"¬°Gracias! Nos pondremos en contacto pronto.",report:"Informe",download:"Descargar / Imprimir",backhome:"Volver al inicio",pillars:"Pilares",elements:"Cinco Elementos",lucky:"Colores de la Suerte",strongest:"M√°s fuerte",weakest:"M√°s d√©bil"}};
function detectLang(){try{const s=localStorage.getItem('ff_lang');if(s)return s;const n=(navigator.languages&&navigator.languages[0])||navigator.language||'en';if(n.toLowerCase().startsWith('zh'))return 'zh';if(n.toLowerCase().startsWith('es'))return 'es';return 'en';}catch(e){return 'en';}}
function setLang(l){localStorage.setItem('ff_lang',l);applyLang(l);}
function applyLang(l){const t=I18N[l]||I18N.en;document.title=t.title;const set=(id,key)=>{const e=document.getElementById(id);if(e&&t[key])e.textContent=t[key];};set('title-text','title');set('i_auto_four','auto_four');set('i_tip','tip');set('i_country_label','country');set('i_date_label','birth_date');set('i_time_label','birth_time');set('i_tst','tst');set('i_lon_label','lon');set('i_autofill','autofill');const sel=document.getElementById('lang');if(sel&&sel.value!==l)sel.value=l;}
document.addEventListener('DOMContentLoaded',function(){const l=detectLang();applyLang(l);const sel=document.getElementById('lang');if(sel){sel.value=l;sel.addEventListener('change',()=>setLang(sel.value));}});
</script><script>
const COUNTRY_TIME=[["China (+08:00)",480,480,false,"N"],["USA - Los Angeles (-480/-420)",-480,-420,true,"N"],["USA - New York (-300/-240)",-300,-240,true,"N"],["Canada - Toronto (-300/-240)",-300,-240,true,"N"],["Hong Kong (+08:00)",480,480,false,"N"],["Taiwan (+08:00)",480,480,false,"N"],["Japan (+09:00)",540,540,false,"N"],["South Korea (+09:00)",540,540,false,"N"],["Mexico City (-360)",-360,-360,false,"N"],["Spain (+60/+120)",60,120,true,"N"]];
function populateCountrySelect(id){const sel=document.getElementById(id);sel.innerHTML="";COUNTRY_TIME.forEach((r,i)=>{const o=document.createElement('option');o.value=i;o.textContent=r[0];sel.appendChild(o);});}
function inferOffset(idx,dateStr){const r=COUNTRY_TIME[idx];if(!r)return 0;const std=r[1],dst=r[2],has=r[3],hem=r[4];if(!has||!dateStr)return std;const a=dateStr.split('-');const m=parseInt(a[1]||'1',10),d=parseInt(a[2]||'1',10);const mmdd=m*100+d;return hem==="N"?((mmdd>=401&&mmdd<=1031)?dst:std):(((mmdd>=1101&&mmdd<=1231)||(mmdd>=101&&mmdd<=331))?dst:std);}
const STEMS_ZH=["Áî≤","‰πô","‰∏ô","‰∏Å","Êàä","Â∑±","Â∫ö","Ëæõ","Â£¨","Áô∏"]; const BRANCHES_ZH=["Â≠ê","‰∏ë","ÂØÖ","ÂçØ","Ëæ∞","Â∑≥","Âçà","Êú™","Áî≥","ÈÖâ","Êàå","‰∫•"];
function mod(n,m){return((n%m)+m)%m;} function lichunAdjustedYear(d){const y=d.getUTCFullYear(),m=d.getUTCMonth(),da=d.getUTCDate();if(m<1)return y-1;if(m===1&&da<4)return y-1;return y;}
function sexagenaryYear(y){return[mod((y-4),10),mod((y-4),12)];}
function monthPillar(ys,d){const m=d.getUTCMonth(),da=d.getUTCDate();const S={1:4,2:6,3:5,4:6,5:6,6:7,7:8,8:8,9:8,10:7,11:7,12:6};let k=0;if(m===1)k=(da>=S[1])?1:12;else if(m===2)k=(da>=S[2])?2:1;else if(m===3)k=(da>=S[3])?3:2;else if(m===4)k=(da>=S[4])?4:3;else if(m===5)k=(da>=S[5])?5:4;else if(m===6)k=(da>=S[6])?6:5;else if(m===7)k=(da>=S[7])?7:6;else if(m===8)k=(da>=S[8])?8:7;else if(m===9)k=(da>=S[9])?9:8;else if(m===10)k=(da>=S[10])?10:9;else if(m===11)k=(da>=S[11])?11:10;else if(m===0)k=(da>=S[12])?12:11;const b=mod(2+(k-1),12);const start={0:2,5:2,1:4,6:4,2:6,7:6,3:8,8:8,4:0,9:0}[ys];const s=mod(start+(k-1),10);return[s,b];}
function julianDayNumber(y,m,d){const a=Math.floor((14-m)/12);const y2=y+4800-a;const m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
function sexagenaryDay(y,m,d){const j=julianDayNumber(y,m,d);const idx=mod(j+49,60);return[idx%10,idx%12];}
function hourBranchIndex(h){return Math.floor(((h+1)%24)/2);} function hourStemIndex(ds,hb){const start={0:0,5:0,1:2,6:2,2:4,7:4,3:6,8:6,4:8,9:8}[ds];return mod(start+hb,10);}
function parseOffsetMinutes(raw){if(raw==null)return 0;const s=String(raw).trim();if(s==="")return 0;const m=s.match(/^([+-]?)(\d{1,2})(?::?(\d{2}))?$/);if(m){const sign=m[1]==="-"?-1:1;const hh=parseInt(m[2]||"0",10);const mm=parseInt(m[3]||"0",10);if(hh<=24)return sign*(hh*60+mm);}const n=Number(s);if(!isNaN(n)){if(Math.abs(n)<=24)return Math.round(n*60);return Math.round(n);}throw new Error("Invalid UTC offset");}
function dayOfYearUTC(date){const start=Date.UTC(date.getUTCFullYear(),0,1);return Math.floor((date.getTime()-start)/(1000*60*60*24))+1;}
function equationOfTimeMinutes(doy){const B=2*Math.PI*(doy-81)/364.0;return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);}
function standardMeridianDeg(off){return(off/60)*15;}
function adjustHourByTST(hr,min,lon,off,utcDate){const std=standardMeridianDeg(off);const delta=4*(lon-std)+equationOfTimeMinutes(dayOfYearUTC(utcDate));const total=hr*60+min+delta;let m=((total%1440)+1440)%1440;return{hour:Math.floor(m/60),minute:Math.round(m%60)};}
function autoFourPillarsFromInput(dateStr,timeStr,offStr){if(!dateStr)throw new Error("Missing date");const a=dateStr.split('-');const y=parseInt(a[0],10),m=parseInt(a[1],10),d=parseInt(a[2],10);let hr=12,min=0;if(timeStr){const p=timeStr.split(':');hr=parseInt(p[0]||'12',10);min=parseInt(p[1]||'0',10);}const off=parseOffsetMinutes(offStr);const local=new Date(Date.UTC(y,(m-1),d,hr,min));const utc=new Date(local.getTime()-off*60*1000);const yAdj=lichunAdjustedYear(utc);const yP=sexagenaryYear(yAdj);const mP=monthPillar(yP[0],utc);const dP=sexagenaryDay(utc.getUTCFullYear(),utc.getUTCMonth()+1,utc.getUTCDate());let hFor=hr;const tst=document.getElementById('ff-tst')?.checked;const lon=parseFloat((document.getElementById('ff-lon')?.value||'').trim());if(tst&&!isNaN(lon)){const adj=adjustHourByTST(hr,min,lon,off,utc);hFor=adj.hour;const l=document.getElementById('ff-tst-time');if(l){const tt=(I18N[detectLang()]||I18N.en).tst_show;l.textContent=tt+': '+String(adj.hour).padStart(2,'0')+':'+String(adj.minute).padStart(2,'0');}}else{const l=document.getElementById('ff-tst-time');if(l)l.textContent='';}const hb=hourBranchIndex(hFor);const hs=hourStemIndex(dP[0],hb);return{year:{stemIdx:yP[0],branchIdx:yP[1]},month:{stemIdx:mP[0],branchIdx:mP[1]},day:{stemIdx:dP[0],branchIdx:dP[1]},hour:{stemIdx:hs,branchIdx:hb}};}
const ELEMENTS=["Wood","Fire","Earth","Metal","Water"];
const STEMS_DATA=[{zh:"Áî≤",e:"Wood"},{zh:"‰πô",e:"Wood"},{zh:"‰∏ô",e:"Fire"},{zh:"‰∏Å",e:"Fire"},{zh:"Êàä",e:"Earth"},{zh:"Â∑±",e:"Earth"},{zh:"Â∫ö",e:"Metal"},{zh:"Ëæõ",e:"Metal"},{zh:"Â£¨",e:"Water"},{zh:"Áô∏",e:"Water"}];
const BRANCHES_DATA=[{zh:"Â≠ê",e:["Water"]},{zh:"‰∏ë",e:["Earth","Water","Metal"]},{zh:"ÂØÖ",e:["Wood","Fire","Earth"]},{zh:"ÂçØ",e:["Wood"]},{zh:"Ëæ∞",e:["Earth","Wood","Water"]},{zh:"Â∑≥",e:["Fire","Metal","Earth"]},{zh:"Âçà",e:["Fire","Earth"]},{zh:"Êú™",e:["Earth","Wood","Fire"]},{zh:"Áî≥",e:["Metal","Water","Earth"]},{zh:"ÈÖâ",e:["Metal"]},{zh:"Êàå",e:["Earth","Fire","Metal"]},{zh:"‰∫•",e:["Water","Wood"]}];
function buildSelect(options,id){const sel=document.getElementById(id);sel.innerHTML="";options.forEach((o,i)=>{const opt=document.createElement('option');opt.value=i;opt.textContent=o.zh;sel.appendChild(opt);});}
function tally(si,bi){const c={Wood:0,Fire:0,Earth:0,Metal:0,Water:0};c[STEMS_DATA[si].e]+=1;BRANCHES_DATA[bi].e.forEach(e=>c[e]+=1);return c;}
function totalCounts(arr){const t={Wood:0,Fire:0,Earth:0,Metal:0,Water:0};arr.forEach(c=>ELEMENTS.forEach(e=>t[e]+=c[e]));return t;}
function luckyBy(e){const map={Wood:["green","cyan"],Fire:["red","orange"],Earth:["yellow","brown"],Metal:["white","silver","gold"],Water:["black","blue","navy"]};return map[e]||[];}
function renderBars(counts){
  const c=document.getElementById('five-bars'); if(!c) return;
  c.innerHTML='';
  const t=(I18N[detectLang()]||I18N.en);
  ELEMENT_KEYS.forEach(key=>{
    const bar=document.createElement('div'); bar.className='bar';
    const v=counts[key]||0; bar.style.height=(10+v*22)+'px';
    const label=document.createElement('span'); label.textContent=`${t.elem_names[key]} 

function renderResultTable(counts){
  const t=(I18N[detectLang()]||I18N.en);
  const table = document.createElement('table');
  table.style.width='100%'; table.style.borderCollapse='collapse'; table.style.marginTop='8px';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr>
    <th style="text-align:left;border-bottom:1px solid #2a3d63;padding:6px 8px">${t.elements}</th>
    <th style="text-align:right;border-bottom:1px solid #2a3d63;padding:6px 8px">#</th>
  </tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  const keys=['Wood','Fire','Earth','Metal','Water'];
  keys.forEach(k=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td style="padding:6px 8px;border-bottom:1px dashed #2a3d63">${t.elem_names[k]}</td>
                    <td style="padding:6px 8px;text-align:right;border-bottom:1px dashed #2a3d63">${counts[k]||0}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  const host = document.getElementById('result-json');
  if(host){
    host.replaceWith(table);
    table.id = 'result-table';
  }
}

${v}`;
    bar.appendChild(label); c.appendChild(bar);
  });
} ${v}`;bar.appendChild(label);c.appendChild(bar);});}
function calcAndShow(){const ids=['year','month','day','hour'];const arr=ids.map(p=>{const s=parseInt(document.getElementById(p+'-stem').value,10);const b=parseInt(document.getElementById(p+'-branch').value,10);return tally(s,b);});const t=totalCounts(arr);renderBars(t);const order=Object.entries(t).sort((a,b)=>b[1]-a[1]);const most=order[0][0],least=order[4][0];const lucky=luckyBy(least);localStorage.setItem('ff_result',JSON.stringify({counts:t,most,least,lucky}));const adv=document.getElementById('advice');if(adv){const tt=I18N[detectLang()]||I18N.en;adv.innerHTML=`<b>${tt.strongest}:</b> ${most}<br/><b>${tt.weakest}:</b> ${least}<br/><b>${tt.lucky}:</b> ${lucky.join(", ")||"‚Äî"}`;}
}
</script><script>
document.addEventListener('DOMContentLoaded',function(){
  ['year','month','day','hour'].forEach(p=>{buildSelect(STEMS_DATA,p+'-stem');buildSelect(BRANCHES_DATA,p+'-branch');});
  document.getElementById('calc-btn')?.addEventListener('click',calcAndShow);
  safePopulateCountry();
  function sync(){ safeInferOffset(); }
  document.getElementById('ff-country').addEventListener('change',sync);
  document.getElementById('ff-date').addEventListener('change',sync); sync();
  document.getElementById('ff-autofill').addEventListener('click',function(){
    const err=document.getElementById('ff-error'); err.style.display='none';
    const ds=(document.getElementById('ff-date').value||'').trim();
    const ts=(document.getElementById('ff-time').value||'').trim();
    const os=(document.getElementById('ff-offset').value||'0').trim();
    if(!ds){err.textContent=(I18N[detectLang()]||I18N.en).err_date;err.style.display='block';return;}
    try{
      const p=autoFourPillarsFromInput(ds,ts,os);
      const map={year:'year',month:'month',day:'day',hour:'hour'};
      Object.keys(map).forEach(k=>{const s=document.getElementById(map[k]+'-stem');const b=document.getElementById(map[k]+'-branch');s.value=String(p[k].stemIdx);b.value=String(p[k].branchIdx);});
      const S=STEMS_ZH,B=BRANCHES_ZH;const fmt=q=>S[q.stemIdx]+B[q.branchIdx];
      document.getElementById('ff-disp').innerHTML=`<div class="mono" style="padding:10px;border:1px solid #eee;border-radius:8px"><b>Pillars:</b> ${fmt(p.year)} ${fmt(p.month)} ${fmt(p.day)} ${fmt(p.hour)}</div>`;
      calcAndShow();
      document.getElementById('five-bars')?.scrollIntoView({behavior:'smooth',block:'center'});
    }catch(e){err.textContent=e.message||'Error';err.style.display='block';console.error(e);}
  });
});
</script></body></html>